name: build app

on:
  push:
    branches:
      - develop
env:
  ONEPUB_TOKEN: ${{ secrets.ONEPUB_TOKEN }}
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

jobs:
  build_android:
    name: Build Android
    runs-on: ubuntu-latest
    timeout-minutes: 20
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          #          flutter-version: '3.19.4'
          cache: true

      - name: OnePub auth
        shell: bash
        run: |
          dart pub global activate onepub
          export ONEPUB_TOKEN=${{ env.ONEPUB_TOKEN }}
          onepub import


      - name: Bootstrap Flutter dependencies
        shell: bash
        run: flutter pub get

      - name: Build Application
        run: flutter build appbundle

  build_ios:
    name: Build iOS
    runs-on: [ self-hosted, macOS, flutter, xcode15.3 ]
    env:
      DEVELOPER_DIR: /Applications/Xcode_15.3.app/Contents/Developer
      SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY_MOBILE }}
      LC_ALL: en_US.UTF-8
      LANG: en_US.UTF-8
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Setup environment and bootstrap dependencies
        uses: ./.github/actions/common-steps-ios
        with:
          ssh-private-key: ${{ env.SSH_KEY }}
          project-directory: ./ios

      - name: Build iOS
        working-directory: ./ios
        run: |
          source ~/.zshrc
          flutter build ipa --no-codesign

#        - name: Notify Slack
#          uses: ./.github/actions/slack
#          if: always()
#          continue-on-error: true
#          with:
#            job-name: Build iOS